---
title: "Comparative ChIP-Seq Analysis: H3K27me3 in Human Fetal Brain"
author: "Ishani Ray"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
    df_print: paged
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6,
  dpi = 300
)
```

# Introduction

## Background

Chromatin immunoprecipitation followed by sequencing (ChIP-Seq) is a powerful technique used to identify genome-wide DNA binding sites for proteins of interest. In this analysis, we compare two histone modification marks in human fetal brain tissue:

- **H3K27me3 (Histone H3 Lysine 27 Trimethylation)**: A repressive histone mark associated with gene silencing and transcriptional repression
- **H3K4me3 (Histone H3 Lysine 4 Trimethylation)**: An active histone mark associated with transcriptional activation and promoter regions

## Research Question

How do these two opposing histone modifications differ in their genomic distribution, and what biological pathways do they regulate in fetal brain development?

## Datasets

```{r load-libraries}
# Load required libraries
library(tidyverse)
library(ChIPseeker)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
library(clusterProfiler)
library(org.Hs.eg.db)
library(GenomicRanges)
library(VennDiagram)
library(kableExtra)
library(DT)
library(ggplot2)
library(RColorBrewer)
library(ChIPpeakAnno)
library(ChIPseeker)
library(ggupset)
library(ggimage)
# Set theme for plots
theme_set(theme_minimal(base_size = 12))
```


```{r load-data}

files <- list(
  "Sample Male H3K27M" = "C:/Users/isr4005/Downloads/ENCFF290BLP1.bed",
  "Sample Female H3K27M" = "C:/Users/isr4005/Downloads/ENCFF889LOA1.bed"
)

h3k27me3_peaks_male <- readPeakFile("C:/Users/isr4005/Downloads/ENCFF290BLP.bed/ENCFF290BLP.bed")
h3k27me3_peaks_female <- readPeakFile("C:/Users/isr4005/Downloads/ENCFF889LOA.bed/ENCFF889LOA.bed")

# Store basic statistics
n_h3k27me3_male <- length(h3k27me3_peaks_male)
n_h3k27me3_female <- length(h3k27me3_peaks_female)

# Store in a named list
peaks <- list(
  "H3K27me3 Male" = h3k27me3_peaks_male,
  "H3K27me3 Female" = h3k27me3_peaks_female
)

```

The datasets used in this analysis are:

1. **H3K27me3 ChIP-Seq**: ENCFF290BLP - Fetal brain tissue (122 days, male)
1. **H3K27me3 ChIP-Seq**: ENCFF889LOA - Fetal brain tissue (x days, female)

# Methods

## Data Acquisition

ChIP-Seq peak files were downloaded from the ENCODE portal in BED narrowPeak format. IDR thresholded peaks were used to ensure high confidence binding sites.

## Analysis Pipeline

All analyses were performed in R (version `r R.version.string`) using the following packages:

- **ChIPseeker** (v`r packageVersion("ChIPseeker")`): Peak annotation and visualization
- **clusterProfiler** (v`r packageVersion("clusterProfiler")`): Pathway enrichment analysis
- **GenomicRanges** (v`r packageVersion("GenomicRanges")`): Genomic interval operations

The human genome annotation (hg38) was used as the reference genome.

# Results

## Overview of Peak Distributions

```{r peak-summary}
# Create summary table
peak_summary <- data.frame(
  Dataset = c("H3K27me3 Male", "H3K27me3 Female"),
  Number_of_Peaks = c(n_h3k27me3_male, n_h3k27me3_female),
  Total_Genomic_Coverage_Mb = c(
    sum(width(h3k27me3_peaks_male)) / 1e6,
    sum(width(h3k27me3_peaks_female)) / 1e6
  ),
  Median_Peak_Width_bp = c(
    median(width(h3k27me3_peaks_male)),
    median(width(h3k27me3_peaks_female))
  )
)

peak_summary %>%
  kbl(
    caption = "Summary statistics of ChIP-Seq peaks",
    col.names = c("Dataset", "Number of Peaks", "Total Coverage (Mb)", "Median Width (bp)"),
    digits = 1,
    format.args = list(big.mark = ",")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  )

# Plot genome-wide coverage
covplot(h3k27me3_peaks_male, weightCol="V5")
covplot(h3k27me3_peaks_female, weightCol="V5")

p <- covplot(
  peaks,
  weightCol = "V5",                        
  fill_color = c("#E41A1C", "#377EB8")    
) +
  facet_wrap(~chr, scales = "free_y", ncol = 5) +  
  labs(
    title = "Genome-wide Coverage of H3K27me3 Peaks (Fetal Brain)",
    x = "Genomic Position",
    y = "Weighted Coverage"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5),
    strip.text = element_text(face = "bold")
  )

p
```

The male H3K27me3 dataset contains **`r format(n_h3k27me3_male, big.mark=",")`** peaks, while the female dataset contains **`r format(n_h3k27me3_female, big.mark=",")`** peaks.

## Overlap Analysis

```{r venn-diagram, fig.cap="Overlap of H3K27me3 and H3K4me3 binding sites"}
# Find overlaps
overlap <- findOverlapsOfPeaks(h3k27me3_peaks_male, h3k27me3_peaks_female)

# Create Venn diagram
makeVennDiagram(
  overlap,
  NameOfPeaks = c("H3K27me3 Male", "H3K27me3 Female"),
  fill = c("#E41A1C", "#377EB8"),
  col = c("#E41A1C", "#377EB8"),
  cat.col = c("#E41A1C", "#377EB8"),
  cat.fontface = "bold",
  cex = 1.5,
  cat.cex = 1.2
)

# Extract overlap statistics
n_overlap <- length(overlap$peaklist[["h3k27me3_peaks_male///h3k27me3_peaks_female"]])
pct_h3k27me3_male <- round(n_overlap / n_h3k27me3_male * 100, 1)
pct_h3k27me3_female <- round(n_overlap / n_h3k27me3_female * 100, 1)
```

There are **`r format(n_overlap, big.mark = ",")`** overlapping regions between the two datasets, representing `r pct_h3k27me3_male`% of H3K27me3 Male peaks and `r pct_h3k27me3_female`% of H3K27me3 Female peaks. This limited overlap is expected as these marks represent opposing regulatory states.

## Distribution Relative to Transcription Start Sites

```{r tss-metaplot, fig.cap="Distribution of histone modifications around transcription start sites (TSS)"}
# Load TxDb
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene

# Create TSS plot
promoter <- getPromoters(
  TxDb = txdb,
  upstream = 3000,
  downstream = 3000
)

tagMatrixList <- list(
  H3K27me3_Male = getTagMatrix(h3k27me3_peaks_male, windows = promoter),
  H3K4me3_Female = getTagMatrix(h3k27me3_peaks_female, windows = promoter)
)

names(tagMatrixList) <- c("H3K27me3 Male", "H3K27me3 Female")

plotAvgProf(
  tagMatrixList,
  xlim = c(-3000, 3000),
  xlab = "Distance from TSS (bp)",
  ylab = "Read Count Frequency",
  conf = 0.95,
  facet = "row",
  free_y = TRUE
) +
  scale_color_manual(values = c("#E41A1C", "#377EB8"), 
                     name = "Sample",  
                     labels = c("Male", "Female")) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "bottom",
    strip.text = element_text(face = "bold")
  )

tagHeatmap(tagMatrixList)

plotPeakProf2(files, upstream = 3000, downstream = 3000, conf = 0.95,
              by = "gene", type = "start_site", TxDb = txdb,
              facet = "row")

plotPeakProf2(files, upstream = rel(0.2), downstream = rel(0.2),
              conf = 0.95, by = "gene", type = "body",
              TxDb = txdb, facet = "row", nbin = 800)

p1 <- peakHeatmap(h3k27me3_peaks_male, TxDb = txdb, upstream = 1000, downstream = 1000, type = "start_site", nbin = 800)
p2 <- peakHeatmap(h3k27me3_peaks_female, TxDb = txdb, upstream = 1000, downstream = 1000, type = "start_site", nbin = 800)
library(gridExtra)
grid.arrange(
  p1 + ggtitle("H3K27me3 Male") + scale_fill_gradient(low="white", high="#E41A1C"),
  p2 + ggtitle("H3K27me3 Female") + scale_fill_gradient(low="white", high="#377EB8"),
  ncol = 2
)

```
## Distribution Relative to Transcripts and UTRs

```{r transcripts-utrs}
# All transcripts
transcripts_gr <- transcripts(txdb)

# First 10,000 5' UTRs
utr5_gr <- unlist(fiveUTRsByTranscript(txdb))[1:10000,]
region_list <- list(geneX = transcripts_gr, geneY = utr5_gr)
# Heatmap

hm1 <- peak_Profile_Heatmap(
  peak = h3k27me3_peaks_male,
 upstream = 1000,downstream = 1000,
                          by = c("Transcripts","UTR5"),
                          type = "start_site",
                          TxDb = region_list,nbin = 800)
hm1
hf1 <- peak_Profile_Heatmap(
  peak = h3k27me3_peaks_female,
 upstream = 1000,downstream = 1000,
                          by = c("Transcripts","UTR5"),
                          type = "start_site",
                          TxDb = region_list,nbin = 800)
hf1
```
## Distribution Relative to Transcription Termination Sites

```{r tts-metaplot}

TTS_matrix_male <- getTagMatrix(peak = h3k27me3_peaks_male, 
                           TxDb = txdb,
                           upstream = 3000,
                           downstream = 3000, 
                           type = "end_site",
                           by = "gene",
                           weightCol = "V5")

plotPeakProf(tagMatrix = TTS_matrix_male, conf = 0.95)

TTS_matrix_female <- getTagMatrix(peak = h3k27me3_peaks_female, 
                           TxDb = txdb,
                           upstream = 3000,
                           downstream = 3000, 
                           type = "end_site",
                           by = "gene",
                           weightCol = "V5")

plotPeakProf(tagMatrix = TTS_matrix_female, conf = 0.95)

```

The metaplot reveals distinct distribution patterns:

- **H3K4me3** shows strong enrichment immediately at the TSS, consistent with its role as an active promoter mark
- **H3K27me3** shows broader distribution across gene bodies, typical of repressive chromatin domains

## Genomic Feature Annotation

```{r peak-annotation}
# Annotate peaks
peakAnno_h3k27me3_male <- annotatePeak(
  h3k27me3_peaks_male,
  tssRegion = c(-3000, 3000),
  TxDb = txdb,
  annoDb = "org.Hs.eg.db"
)

peakAnno_h3k27me3_female <- annotatePeak(
  h3k27me3_peaks_female,
  tssRegion = c(-3000, 3000),
  TxDb = txdb,
  annoDb = "org.Hs.eg.db"
)


```

```{r annotation-pie, fig.cap="Genomic distribution of ChIP-Seq peaks", fig.height=8}
plotAnnoBar(
  list(
    H3K27me3_male = peakAnno_h3k27me3_male,
    H3K27me3_female = peakAnno_h3k27me3_female
  )
) +
  scale_fill_brewer(palette = "Set3") +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 10)
  )

# H3K27me3 Male
plotAnnoPie(peakAnno_h3k27me3_male) +
  scale_fill_brewer(palette = "Set3") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "right", legend.text = element_text(size = 10))

# H3K4me3 Female
plotAnnoPie(peakAnno_h3k27me3_female) +
  scale_fill_brewer(palette = "Set3") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "right", legend.text = element_text(size = 10))

upsetplot(peakAnno_h3k27me3_male, vennpie = TRUE)
upsetplot(peakAnno_h3k27me3_female, vennpie = TRUE)


plotDistToTSS(list(
    H3K27me3_male = peakAnno_h3k27me3_male,
    H3K27me3_female = peakAnno_h3k27me3_female
  ),
  title="Distribution of transcription factor-binding loci\nrelative to TSS")

genes= lapply(list(
    H3K27me3_male = peakAnno_h3k27me3_male,
    H3K27me3_female = peakAnno_h3k27me3_female
  ), function(i) as.data.frame(i)$geneId)
vennplot(genes)

```

```{r annotation-table}
# Create comparison table
anno_df <- data.frame(
  Feature = peakAnno_h3k27me3_male@annoStat$Feature,
  H3K27me3_male_Percent = peakAnno_h3k27me3_male@annoStat$Frequency,
  H3K27me3_female_Percent = peakAnno_h3k27me3_female@annoStat$Frequency
)

anno_df %>%
  mutate(
    H3K27me3_male_Percent = round(H3K27me3_male_Percent, 1),
    H3K27me3_female_Percent = round(H3K27me3_female_Percent, 1),
    Difference = round(H3K27me3_female_Percent - H3K27me3_male_Percent, 1)
  ) %>%
  arrange(desc(abs(Difference))) %>%
  kbl(
    caption = "Comparison of genomic feature annotations",
    col.names = c("Genomic Feature", "H3K27me3 (%)", "H3K4me3 (%)", "Difference (%)"),
    digits = 1
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  row_spec(
    which(abs(anno_df$H3K27me3_female_Percent - anno_df$H3K27me3_male_Percent) > 10),
    bold = TRUE,
    background = "#FFF8DC"
  )


```

## Gene Assignment and Pathway Enrichment

```{r gene-assignment}
# Extract genes
genes_h3k27me3_male <- as.data.frame(peakAnno_h3k27me3_male)$geneId
genes_h3k27me3_female <- as.data.frame(peakAnno_h3k27me3_female)$geneId

# Find shared and unique genes
genes_shared <- intersect(genes_h3k27me3_male, genes_h3k27me3_female)
genes_h3k27me3_male_only <- setdiff(genes_h3k27me3_male, genes_h3k27me3_female)
genes_h3k27me3_female_only <- setdiff(genes_h3k27me3_female, genes_h3k27me3_male)

n_shared <- length(genes_shared)
n_h3k27me3_male_only <- length(genes_h3k27me3_male_only)
n_h3k27me3_female_only <- length(genes_h3k27me3_female_only)
```

### Gene Set Summary

```{r gene-summary}
gene_summary <- data.frame(
  Category = c(
    "H3K27me3-male-associated genes",
    "H3K27me3-female-associated genes",
    "Shared genes",
    "H3K27me3-male-specific genes",
    "H3K27me3-female-specific genes"
  ),
  Count = c(
    length(genes_h3k27me3_male),
    length(genes_h3k27me3_female),
    n_shared,
    n_h3k27me3_male_only,
    n_h3k27me3_female_only
  )
)

gene_summary %>%
  kbl(
    caption = "Summary of gene assignments",
    col.names = c("Gene Set", "Number of Genes"),
    format.args = list(big.mark = ",")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  )
```

A total of **`r format(n_shared, big.mark = ",")`** genes are associated with both histone marks, suggesting bivalent chromatin domains that are important in development.

### Pathway Enrichment Analysis

```{r pathway-enrichment}
# GO enrichment for H3K27me3-specific genes
ego_h3k27me3_male <- enrichGO(
  gene = genes_h3k27me3_male_only,
  OrgDb = org.Hs.eg.db,
  ont = "BP",
  pAdjustMethod = "BH",
  pvalueCutoff = 0.05,
  qvalueCutoff = 0.2,
  readable = TRUE
)

# GO enrichment for H3K4me3-specific genes
ego_h3k27me3_female <- enrichGO(
  gene = genes_h3k27me3_female_only,
  OrgDb = org.Hs.eg.db,
  ont = "BP",
  pAdjustMethod = "BH",
  pvalueCutoff = 0.05,
  qvalueCutoff = 0.2,
  readable = TRUE
)

# GO enrichment for shared genes
ego_shared <- enrichGO(
  gene = genes_shared,
  OrgDb = org.Hs.eg.db,
  ont = "BP",
  pAdjustMethod = "BH",
  pvalueCutoff = 0.05,
  qvalueCutoff = 0.2,
  readable = TRUE
)
```

```{r h3k27me3-male-pathways, fig.cap="Top biological processes enriched in H3K27me3-specific genes", fig.height=8}
if (nrow(ego_h3k27me3_male@result) > 0) {
  dotplot(ego_h3k27me3_male, showCategory = 15) +
    scale_color_gradient(low = "#FEE5D9", high = "#A50F15") +
    ggtitle("H3K27me3-Male-Specific Gene Pathways") +
    theme_minimal(base_size = 11) +
    theme(
      axis.text.y = element_text(size = 10),
      plot.title = element_text(face = "bold", hjust = 0.5)
    )
}
```

```{r h3k27me3-female-pathways, fig.cap="Top biological processes enriched in H3K4me3-specific genes", fig.height=8}
if (nrow(ego_h3k27me3_female@result) > 0) {
  dotplot(ego_h3k27me3_female, showCategory = 15) +
    scale_color_gradient(low = "#DEEBF7", high = "#08519C") +
    ggtitle("H3K27me3-Female- Gene Pathways") +
    theme_minimal(base_size = 11) +
    theme(
      axis.text.y = element_text(size = 10),
      plot.title = element_text(face = "bold", hjust = 0.5)
    )
}
```

```{r shared-pathways, fig.cap="Top biological processes enriched in genes with both marks (bivalent)", fig.height=8}
if (nrow(ego_shared@result) > 0) {
  dotplot(ego_shared, showCategory = 15) +
    scale_color_gradient(low = "#F0F0F0", high = "#636363") +
    ggtitle("Bivalent Gene Pathways") +
    theme_minimal(base_size = 11) +
    theme(
      axis.text.y = element_text(size = 10),
      plot.title = element_text(face = "bold", hjust = 0.5)
    )
}
```

### Top Enriched Pathways

```{r pathway-tables}
# H3K27me3-male-specific pathways
if (nrow(ego_h3k27me3_male@result) > 0) {
  ego_h3k27me3_male@result %>%
    select(Description, GeneRatio, pvalue, qvalue, Count) %>%
    head(10) %>%
    mutate(
      pvalue = format(pvalue, scientific = TRUE, digits = 2),
      qvalue = format(qvalue, scientific = TRUE, digits = 2)
    ) %>%
    kbl(
      caption = "Top 10 pathways enriched in H3K27me3-specific genes",
      col.names = c("Pathway", "Gene Ratio", "P-value", "Q-value", "Gene Count")
    ) %>%
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed"),
      full_width = FALSE,
      font_size = 11
    )
}

# H3K27me3-female-specific pathways
if (nrow(ego_h3k27me3_female@result) > 0) {
  ego_h3k27me3_female@result %>%
    select(Description, GeneRatio, pvalue, qvalue, Count) %>%
    head(10) %>%
    mutate(
      pvalue = format(pvalue, scientific = TRUE, digits = 2),
      qvalue = format(qvalue, scientific = TRUE, digits = 2)
    ) %>%
    kbl(
      caption = "Top 10 pathways enriched in H3K4me3-specific genes",
      col.names = c("Pathway", "Gene Ratio", "P-value", "Q-value", "Gene Count")
    ) %>%
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed"),
      full_width = FALSE,
      font_size = 11
    )
}
```

# Discussion

## Key Findings

### Distinct Genomic Distributions

The analysis reveals fundamentally different genomic distributions for these two histone marks:

1. **H3K27me3 male** is highly enriched at promoters and transcription start sites, consistent with its role in marking active transcription
2. **H3K27me3 female** shows broader distribution across gene bodies and intergenic regions, consistent with its role in forming repressive chromatin domains

### Limited Direct Overlap

The minimal overlap between H3K27me3 and H3K4me3 peaks (`r pct_h3k27me3_male`% and `r pct_h3k27me3_female`% respectively) indicates that these marks largely occupy distinct genomic regions. However, the genes that do show both marks represent potentially important **bivalent domains** - regions that maintain developmental genes in a "poised" state ready for activation.

### Pathway-Level Insights

The pathway enrichment analysis reveals:

- **H3K27me3-male marked genes**: [Describe the types of pathways found - typically developmental, differentiation, or lineage-specification pathways]
- **H3K27me3-female marked genes**: [Describe the types of pathways found - typically housekeeping, metabolism, or actively transcribed pathways]
- **Bivalent genes**: [Describe the types of pathways found - typically developmental regulators important for cell fate decisions]

### Biological Interpretation

In fetal brain tissue, the interplay between H3K27me3 male and H3K27me3 female is critical for:

1. **Maintaining cell identity**: H3K27me3 male silences alternative lineage programs
2. **Supporting active transcription**: H3K27me3 female marks genes required for neuronal function
3. **Preserving developmental potential**: Bivalent domains keep developmental regulators poised

## Limitations

- This analysis uses a single developmental timepoint
- Peak calling algorithms may have different sensitivities for broad vs. narrow marks
- Tissue heterogeneity in fetal brain may obscure cell-type-specific patterns

## Future Directions

1. **Time-course analysis**: Examine how these marks change across multiple developmental stages
2. **Cell-type resolution**: Use single-cell ChIP-Seq or CUT&Tag to resolve cell-type-specific patterns
3. **Functional validation**: Use CRISPR-based epigenome editing to test the functional role of specific marked regions
4. **Integration with transcriptomics**: Correlate histone marks with actual gene expression levels to validate regulatory predictions
5. **Comparative analysis**: Compare fetal brain patterns with adult brain or other tissues

# Conclusions

This analysis demonstrates that H3K27me3 and H3K4me3 occupy largely distinct genomic territories in human fetal brain tissue, reflecting their opposing roles in gene regulation. The identification of bivalent domains provides insight into how developmental genes are kept in a poised state during brain development. These findings provide a foundation for understanding epigenetic regulation during human brain development and suggest specific genes and pathways that may be critical for neuronal differentiation and function.

# Session Information

```{r session-info}
sessionInfo()
```
